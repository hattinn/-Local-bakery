<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>キクちゃんテトリス</title>
    <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<section>
    <div class="can-wrapper">
        <canvas id="can" class="can"></canvas>
        <div id="control" class="control">
            <div id="buttonwrap" class="buttonwrap">
                <button id="left" class="left" >
                    <i class="fas fa-caret-left" ></i></button>
                <button id="rotate" class="rotate ">
                    <i class="fas fa-redo-alt"></i></button>
                <button id="down" class="down">
                    <i class="fas fa-sort-down"></i></button>
                <button id="right" class="right">
                    <i class="fas fa-caret-right"></i></button>
            </div>
        </div>
    </div>
</section>

<audio id="bgm1" src="bgm1.mp3" autoplay></audio>
<audio id="bgm2" src="bgm2.mp3" ></audio>
<audio id="bgm3" src="bgm3.mp3" ></audio>
<audio id="se1" src="se1.mp3"></audio>
<audio id="se2" src="se2.mp3"></audio>
<audio id="se3" src="se3.mp3"></audio>
<audio id="over1" src="over1.mp3"></audio>
<audio id="over2" src="over2.mp3"></audio>
<!--<audio id="chanchan" src="chanchan.mp3"></audio>-->

<script>
// スマホ ⇔ PC表示切り替え
let window_size = window.innerWidth;
const wrap = document.getElementById('buttonwrap');
if(window_size>=601)wrap.classList.add('off');


//BGM,効果音
let bgm1 = document.getElementById("bgm1");
let bgm2 = document.getElementById("bgm2");
let bgm3 = document.getElementById("bgm3");
bgm2.volume = 0.3;
bgm3.volume = 0.3;
let bgm  = bgm1;/*BGM初期値*/
var bgmFlags = [0,0,0];
console.log(bgmFlags);

let se1  = document.getElementById("se1");  /*衝突*/
let se2  = document.getElementById("se2");  /*ライン消去*/
let se3  = document.getElementById("se3");  /*回転*/
se3.volume = 0.5;

let overBgm1 = document.getElementById("over1");
let overBgm2 = document.getElementById("over2");
overBgm1.volume = 0.5;
overBgm2.volume = 0.7;
let overBgm = overBgm2;/*ゲームオーバー音*/

// スコア
let lv    = 0;
let lvb   = 1;/*レベルボーナス*/
let linec = 0;/*消したライン数*/
let score = 0;/*トータルスコア*/

//落ちるスピード
let gameSpeed = 1000;/* 初期値*/

//フィールドサイズ
const FIELD_COL = 10;
const FIELD_ROW = 18;

//ブロック一つのサイズ(ピクセル)
const BLOCK_SIZE = 30;

//スクリーンサイズ
const SCREEN_W = BLOCK_SIZE * FIELD_COL;
const SCREEN_H = BLOCK_SIZE * FIELD_ROW;

//テトロミノのサイズ
const TETRO_SIZE =4;

const TETRO_COLORS =[
	"#000",			//0空
	"#6CF",			//1水色
	"#F92",			//2オレンジ
	"#66F",			//3青
	"#C5C",			//4紫
	"#FD2",			//5黄色
	"#F44",			//6赤
	"#5B5"			//7緑
];

const TETRO_TYPES = [
	[],	// 0.空っぽ
	
	[					// 1.I
		[ 0, 0, 0, 0 ],
		[ 1, 1, 1, 1 ],
		[ 0, 0, 0, 0 ],
		[ 0, 0, 0, 0 ]
	],
	[					// 2.L
		[ 0, 1, 0, 0 ],
		[ 0, 1, 0, 0 ],
		[ 0, 1, 1, 0 ],
		[ 0, 0, 0, 0 ]
	],
	[					// 3.J
		[ 0, 0, 1, 0 ],
		[ 0, 0, 1, 0 ],
		[ 0, 1, 1, 0 ],
		[ 0, 0, 0, 0 ]
	],
	[					// 4.T
		[ 0, 1, 0, 0 ],
		[ 0, 1, 1, 0 ],
		[ 0, 1, 0, 0 ],
		[ 0, 0, 0, 0 ]
	],
	[					// 5.O
		[ 0, 0, 0, 0 ],
		[ 0, 1, 1, 0 ],
		[ 0, 1, 1, 0 ],
		[ 0, 0, 0, 0 ]
	],
	[					// 6.Z
		[ 0, 0, 0, 0 ],
		[ 1, 1, 0, 0 ],
		[ 0, 1, 1, 0 ],
		[ 0, 0, 0, 0 ]
	],
	[					// 7.S
		[ 0, 0, 0, 0 ],
		[ 0, 1, 1, 0 ],
		[ 1, 1, 0, 0 ],
		[ 0, 0, 0, 0 ]
	]
];

//初期位置
const START_X = FIELD_COL/2 - TETRO_SIZE/2;
const START_Y = 0;

//テトロミノ本体
let tetro;
//テトロミノの形
let tetro_t;

//テトロミノの座標
let tetro_x = START_X;
let tetro_y = START_Y;

//フィールド本体
let field = [];

//ゲームオーバーフラグ
let over = false;

let can = document.getElementById("can");
let con = can.getContext("2d");

can.width  = SCREEN_W;
can.height = SCREEN_H;

tetro_t = Math.floor( Math.random()*(TETRO_TYPES.length-1) )+1;
tetro = TETRO_TYPES[ tetro_t ];

// //背景画像を生成
// var bgimg = new Image();
// bgimg.src = "bgi1.png";

// //画像をcanvasに設定
// bgimg.onload = function(){
// con.drawImage(bgimg, 0, 0, 300, 600);  //300x600に縮小表示
// }


init();
drawAll();
setInterval( dropTetro, gameSpeed );



//初期化
function init()
{
	//フィールドのクリア
	for(let y=0; y<FIELD_ROW ; y++ )
	{
		field[y] = [];
		for(let x=0; x<FIELD_COL ; x++ )
		{
			field[y][x] =0;
		}
	}
	/*
	テスト
	field[5][8]  = 1;
	*/
}

//ブロック一つを描画
function drawBlock(x,y,c)
{
	let px = x * BLOCK_SIZE;
	let py = y * BLOCK_SIZE;
	con.fillStyle=TETRO_COLORS[c];
	con.fillRect(px,py,BLOCK_SIZE,BLOCK_SIZE);
	con.strokeStyle="black";
	con.strokeRect(px,py,BLOCK_SIZE,BLOCK_SIZE);
}

//全部描画
function drawAll()
{
	con.clearRect(0,0,SCREEN_W,SCREEN_H);
	
	for(let y=0; y<FIELD_ROW ; y++ )
	{
		for(let x=0; x<FIELD_COL ; x++ )
		{
			if( field[y][x] )
			{
				drawBlock(x,y,field[y][x]);
			}
		}
	}
	for(let y=0; y<TETRO_SIZE ; y++ )
	{
		for(let x=0; x<TETRO_SIZE ; x++ )
		{
			if( tetro[y][x] )
			{
				drawBlock(tetro_x+x, tetro_y+y,tetro_t);
			}
		}
	}
	
	if(over)
	{
	    // chanchan.play();
	  bgm.pause();
	  overBgm.currentTime = 0;
	  if(score>=49999){overBgm=overBgm1;}
	  overBgm.play();
	   
	  con.fillStyle = "rgba(33,33,33,0.6)";
    con.fillRect(0,0,can.width, can.height);
		let s="GAME OVER";
		con.font = "50px 'ＭＳ ゴシック'";
		let w = con.measureText(s).width;
		let x = SCREEN_W/2 - w/2;
		let y = SCREEN_H/2 - 70;
		con.lineWidth = 4;
		con.strokeText(s,x,y);
		con.fillStyle="white";
		con.fillText(s,x,y);
		
		x = SCREEN_W/2 - w/2 -20;
		con.fillstyle = "#555";
		con.fillRect(x,y+90,270,225)
		
		s = "score";
		con.font = " 15px ";
		w = con.measureText(s).width;
		x = SCREEN_W/2 - w/2 - 50;
		y = SCREEN_H/2 + 80;
// 		con.lineWidth = 1;
// 		con.strokeText(s,x,y);
		con.fillStyle="gray";
		con.fillText(s,x,y);
		
		s = ""+score;
		y = SCREEN_H/2 + 140;
// 		con.strokeText(s,x,y);
		con.fillStyle="#3c3";
		con.fillText(s,x,y);
		
		s = "Lv:";
		w = con.measureText(s).width;
		y = SCREEN_H/2 + 220;
// 		con.strokeText(s,x,y);
		con.fillStyle="gray";
		con.fillText(s,x,y);
		
		s = lv;
		con.font = " 20px ";
		x = w + 45;
		con.fillStyle="skyblue";
		con.fillText(s,x,y);
		
		can.onclick = function ()
		{
		 		document.location.reload();
		}
	}
}

// ブロックの衝突判定
function checkMove( mx,my ,ntetro)
{
	if( ntetro == undefined ) ntetro = tetro;
	
	for(let y=0; y<TETRO_SIZE ; y++ )
	{
		for(let x=0; x<TETRO_SIZE ; x++ )
		{
			if(  ntetro[y][x]  )
			{
				let nx = tetro_x + mx + x;
				let ny = tetro_y + my + y;
				
				if( ny < 0 ||
					nx < 0 ||
					ny >= FIELD_ROW ||
					nx >= FIELD_COL ||
					field[ny][nx] )
				{
					return false;
				}
			}
		}
	}
	return true;
}

// テトロの回転
function rotate()
{
	let ntetro = [];
	
	for(let y=0; y<TETRO_SIZE ; y++ )
	{
		ntetro[y]=[];
		for(let x=0; x<TETRO_SIZE ; x++ )
		{
			ntetro[y][x] = tetro[TETRO_SIZE-x-1][y];
		}
	}
	return ntetro;
}

//テトロを固定する
function fixTetro()
{
	for(let y=0; y<TETRO_SIZE ; y++ )
	{
		for(let x=0; x<TETRO_SIZE ; x++ )
		{
			if( tetro[y][x] )
			{
				field[tetro_y + y][tetro_x + x] = tetro_t;
				se1.currentTime = 0;
				se1.play();
			}
		}
	}
}

//ラインが揃ったかチェックして消す

function bgmCheck(check)
{
	bgmFlags[check]++;
	console.log(bgmFlags[check]);
	// console.log();
	// return ;
	
	// console.log(bgmFlogs[check]);
}


function checkLine()
{
	for(let y=0; y<FIELD_ROW ; y++ )
	{
		let flag=true;
		
		for(let x=0; x<FIELD_COL ; x++ )
		{
			if( !field[y][x] )
			{
				flag=false;
				break;
			}
			
			
			
		}
		
		
		/*ラインが消えたら*/
		if(flag)
		{
			// console.log("line消えたよ！");
			linec++;
			// console.log("linec" + linec);
			score = linec * ( lvb * 1000);
			// console.log("score" + score);
			se2.currentTime = 0;
			se2.play();
			
			/*消したライン数合計が４の倍数ごとに*/
			if( linec % 4 == 0 )
			{
			    lv++;
			    lvb = 1 + ( 0.1 * lv );
			    gameSpeed = gameSpeed - 50;
			    if(gameSpeed<=0)gameSpeed = 1;
			}
			
			
			if(linec >= 35 && bgmFlags[1] < 1)
			{
					bgm.pause();
					bgm.currentTime =0;
			    bgm = bgm2;
			    overBgm.play();
			    can.classList.remove('bgi3');
			    can.classList.add('bgi4');
			    
			    bgmCheck(1);
					// bgmFlags.bgmF2++;
			    
			}else if((linec >= 10 || linec >= 70 ) && bgmFlags[2] < 1)
			{
					bgm.pause();
					bgm.currentTime =0;
	        bgm = bgm3;
	        overBgm.play();
	        can.classList.remove('bgi4');
	        can.classList.add('bgi2');
	        bgmCheck(2);
	        
	        // bgmFlags.bgmF3++;
	        
			}else if((linec >= 20 || linec >= 50 || linec >= 100 ) && bgmFlags[0] < 1)
			{
					bgm.pause();
					bgm.currentTime =0;
			    bgm = bgm1;
			    overBgm.play();
			    can.classList.remove('bgi2');
			    can.classList.add('bgi3');
			    
			    bgmCheck(0);
			    
			    // bgmFlags.bgmF1++;
			}
			
			
			for(let ny = y; ny>0 ;ny-- )
			{
				for(let nx=0;nx<FIELD_COL ; nx++)
				{
					field[ny][nx] = field[ny-1][nx];
				}
			}
		}
	}
}

// ブロックの落ちる処理
function dropTetro()
{
	if(over)return;
	
	if( checkMove(  0, 1 ) )tetro_y++;
	else
	{
		fixTetro();
		checkLine();
		tetro_t = Math.floor( Math.random()*(TETRO_TYPES.length-1) )+1;
		tetro = TETRO_TYPES[ tetro_t ];
		tetro_x = START_X;
		tetro_y = START_Y;
		
		if( !checkMove(0,0) )
		{
			over=true;
		}
	}
	drawAll();
}

// スマホ
if(window_size<=600)
{
    // スマホ操作設定
    let tapCount = 0 ;
    
    let tapLeft   = document.getElementById( "left"   );
    let tapRight  = document.getElementById( "right"  );
    let tapDown   = document.getElementById( "down"   );
    let tapRotate = document.getElementById( "rotate" );
    
    tapLeft.addEventListener(  "touchstart", touchLeft  ,{passive:false},{once:true});
    tapRight.addEventListener( "touchend"  , touchRight ,{passive:false},{once:true});
    tapDown.addEventListener(  "touchstart", touchDown  ,{passive:false},{once:true});
    tapRotate.addEventListener("touchstart", touchRotate,{passive:false},{once:true});
 
    // タップ時の処理
    function touchLeft(e)
    {
        e.preventDefault();
        bgm.play();
    		if(over)return;
        if( checkMove( -1, 0 ) ){tetro_x--;}
        drawAll();
    }
    function touchRight(e)
    {
        e.preventDefault();
        bgm.play();
    		if(over)return;
        if( checkMove(  1, 0 ) )tetro_x++;
        drawAll();
    }
    function touchDown(e)
    {
        e.preventDefault();
        bgm.play();
    		if(over)return;
        if( !tapCount )
            	{
            		++tapCount ;
                if( checkMove(  0, 1 ) )tetro_y++;
            		setTimeout( function() {
            			tapCount = 0 ;
            		}, 350) ;
            
            	// ダブルタップ判定
            	} else {
            			while( checkMove(  0, 1 ) )tetro_y++;
            		
            			tapCount = 0 ;
            	}
        drawAll();
    }
    function touchRotate(e)
    {
        e.preventDefault();
        bgm.play();
    		if(over)return;
        
        let ntetro = rotate();
    		if( checkMove( 0, 0, ntetro) )
	    	{
	    	    tetro = ntetro;
	    	    se3.currentTime = 0;
	    	    se3.play();
	    	}
    	drawAll();
    }
}

//キーボードが押された時の処理
document.onkeydown = function(e)
{
	bgm.play();
	
	if(over)return;
	
	switch( e.keyCode )
	{
		case 37:// 左
			if( checkMove( -1, 0 ) )tetro_x--;
			break;
		case 38:// 上キー入力で一気に下まで
			while( checkMove(  0, 1 ) )tetro_y++;
			break;
		case 39:// 右
			if( checkMove(  1, 0 ) )tetro_x++;
			break;
		case 40:// 下
			if( checkMove(  0, 1 ) )tetro_y++;
			break;
		case 32:// スペース
			let ntetro = rotate();
			if( checkMove( 0, 0, ntetro) )
			{
			    tetro = ntetro;
			    se3.currentTime = 0;
			    se3.play();
			    break;
			}
	}
	drawAll();
}
</script>
</body>
</html>
